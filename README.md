# SSO-JWT (Single Sign-On)
## Общее описание

**SSO** - единый вход в систему. Проходя аутентификацию в одном сервисе пользователь может получить доступ и ко всем другим сервисам и программам во всей системе.

**Токен доступа (token)** - токен JWT, получаемый в результате аутентификации и используемый для авторизации во всех сервисах системы.

**Токен продления (refresh_token)** - токен, используемый для генерации нового токена доступа без повторной аутентификации пользователя.

JWT-токен подписывается **ключом (secret_key)**, генерируем для текущего окружения (прод, релиз, тест, дев и т.д.)

Сервис предназначен для централизованной аутентификации и авторизации в системе **пользователей**:

- Доменные пользователи (user)
- Сервисы и программы внутри системы (software)
- Внешние сервисы (external system)

Аутентификация и авторизация в системе выполняется только через сервис SSO-JWT.

**Ограничения:**

- система авторизации должна быть максимально простой к внедрению во все системы (и на разных технологических платформах: 1C, node.JS, PHP, C#, Go);
- количество запросов к сервису SSO должно быть минимальным;

## Аутентификация

1. Любой сервис или программный продукт для SSO должен реализовать получение  данных аутентификации от пользователей и отправить запрос сервису SSO.
2. Сервис SSO, получая запрос осуществляет аутентификацию пользователей в системе *(методики аутентификации разные для разных типов пользователей, будут описаны отдельно)*.
3. В результате генерируется JWT-токен, в Claims которого записывается публичный id пользователя системы, его роли и разрешения, срок действия токена.
4. После аутентификации токен можно использовать во всей системе (в рамках запрошенного scope).

## Авторизация

Авторизация в сервисах выполняется по токену JWT, в Claims которого можно посмотреть некоторые данные пользователя. Авторизация происходит путём проверки подписи JWT и проверки переданного в токене scope.

## Обновление токена доступа

Вместе с токеном доступа может выдаваться и токен продления (срок его жизни больше срока токена доступа). С его помощью сервис может запросить обновление токена доступа, не запрашивая у пользователя данных аутентификации.

## Аутентификация доменных пользователей

**Входные параметры:**

> id
> 
> password
> 
> scope


Пользователи для авторизации используют доменные учётные данные. Сервис SSO через LDAP аутентифицирует пользователя и получает роли пользователя в соответствии со scope. В результате авторизации выполняется генерация JWT-токена и он же (вместе с токеном обновления) кешируется в базе Redis.

## Аутентификация внутренних сервисов

**Входные параметры:**

> id
> 
> password
> 
> scope

Аутентификация внутренних сервисов выполняется в два этапа:

- проверка в LDAP данных пользователя;
- запрос в БД параметров токена авторизации (срок жизни).

## Авторизация внешних сервисов

**Входные параметры:**

> id
> 
> secret
> 
> scope

Аутентификация внутренних сервисов выполняется в два этапа:

- проверка в LDAP данных пользователя;
- запрос в БД параметров токена авторизации (срок жизни).